generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  telegramId        BigInt             @id @map("telegram_id")
  username          String?
  firstName         String?            @map("first_name")
  createdAt         DateTime           @default(now()) @map("created_at")
  admin             Admin?
  broadcastMessages BroadcastMessage[]
  broadcasts        Broadcast[]
  demoAccess        DemoAccess[]
  discountUsage     DiscountUsage[]
  payments          Payment[]
  promoUsage        PromoUsage[]
  subscriptions     Subscription[]

  @@map("users")
}

model Admin {
  telegramId BigInt @id @map("telegram_id")
  user       User   @relation(fields: [telegramId], references: [telegramId])

  @@map("admins")
}

model Channel {
  channelId     BigInt         @id @map("channel_id")
  name          String
  username      String?        @unique
  description   String?
  createdAt     DateTime       @default(now()) @map("created_at")
  products      Product[]
  subscriptions Subscription[]

  @@map("channels")
}

model Product {
  productId     String         @id @default(cuid()) @map("product_id")
  channelId     BigInt         @map("channel_id")
  name          String
  description   String?
  price         Decimal        @db.Decimal(10, 2)
  periodDays    Int            @map("period_days")
  discountPrice Decimal?       @map("discount_price") @db.Decimal(10, 2)
  isTrial       Boolean        @default(false) @map("is_trial")
  isActive      Boolean        @default(true) @map("is_active")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  allowDemo     Boolean        @default(false) @map("allow_demo")
  demoDays      Int            @default(7) @map("demo_days")
  sortOrder     Int?           @map("sort_order")
  demoAccess    DemoAccess[]
  discounts     Discount[]
  payments      Payment[]
  channel       Channel        @relation(fields: [channelId], references: [channelId])
  promoCodes    PromoCode[]
  subscriptions Subscription[]

  @@map("products")
}

model Payment {
  paymentId        String         @id @default(cuid()) @map("payment_id")
  userId           BigInt         @map("user_id")
  productId        String?        @map("product_id")
  amount           Decimal        @db.Decimal(10, 2)
  currency         String         @default("USDT")
  status           String         @default("pending")
  txHash           String?        @unique @map("tx_hash")
  memo             String?        @unique
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  nowPaymentId     String?        @map("now_payment_id")
  orderDescription String?        @map("order_description")
  payAddress       String?        @map("pay_address")
  payAmount        Decimal?       @map("pay_amount") @db.Decimal(20, 8)
  payCurrency      String?        @map("pay_currency")
  priceAmount      Decimal?       @map("price_amount") @db.Decimal(10, 2)
  priceCurrency    String?        @map("price_currency")
  validUntil       DateTime?      @map("valid_until")
  network          String?        @map("network")
  product          Product?       @relation(fields: [productId], references: [productId])
  user             User           @relation(fields: [userId], references: [telegramId])
  subscriptions    Subscription[]

  @@map("payments")
}

model Subscription {
  subscriptionId String   @id @default(cuid()) @map("subscription_id")
  userId         BigInt   @map("user_id")
  productId      String?  @map("product_id")
  channelId      BigInt   @map("channel_id")
  paymentId      String?  @map("payment_id")
  status         String   @default("active")
  startsAt       DateTime @default(now()) @map("starts_at")
  expiresAt      DateTime @map("expires_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  channel        Channel  @relation(fields: [channelId], references: [channelId])
  payment        Payment? @relation(fields: [paymentId], references: [paymentId])
  product        Product? @relation(fields: [productId], references: [productId])
  user           User     @relation(fields: [userId], references: [telegramId])

  @@index([status, expiresAt])
  @@map("subscriptions")
}

model Discount {
  id           String          @id @default(cuid())
  productId    String          @map("product_id")
  type         DiscountType
  value        Decimal         @db.Decimal(10, 2)
  isActive     Boolean         @default(true) @map("is_active")
  startDate    DateTime        @map("start_date")
  endDate      DateTime        @map("end_date")
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")
  usageHistory DiscountUsage[]
  product      Product         @relation(fields: [productId], references: [productId])

  @@map("discounts")
}

model DiscountUsage {
  id         String   @id @default(cuid())
  discountId String   @map("discount_id")
  userId     BigInt   @map("user_id")
  usedAt     DateTime @default(now()) @map("used_at")
  discount   Discount @relation(fields: [discountId], references: [id])
  user       User     @relation(fields: [userId], references: [telegramId])

  @@map("discount_usage")
}

model PromoCode {
  id            String       @id @default(cuid())
  code          String       @unique
  type          PromoType
  discountValue Decimal      @map("discount_value") @db.Decimal(10, 2)
  productId     String?      @map("product_id")
  maxUses       Int?         @map("max_uses")
  currentUses   Int          @default(0) @map("current_uses")
  minAmount     Decimal?     @map("min_amount") @db.Decimal(10, 2)
  isActive      Boolean      @default(true) @map("is_active")
  validFrom     DateTime     @map("valid_from")
  validUntil    DateTime     @map("valid_until")
  createdAt     DateTime     @default(now()) @map("created_at")
  product       Product?     @relation(fields: [productId], references: [productId])
  usageHistory  PromoUsage[]

  @@map("promo_codes")
}

model PromoUsage {
  id        String    @id @default(cuid())
  promoId   String    @map("promo_id")
  userId    BigInt    @map("user_id")
  usedAt    DateTime  @default(now()) @map("used_at")
  promoCode PromoCode @relation(fields: [promoId], references: [id])
  user      User      @relation(fields: [userId], references: [telegramId])

  @@map("promo_usage")
}

model DemoAccess {
  id        String   @id @default(cuid())
  userId    BigInt   @map("user_id")
  productId String   @map("product_id")
  startedAt DateTime @default(now()) @map("started_at")
  expiresAt DateTime @map("expires_at")
  isActive  Boolean  @default(true) @map("is_active")
  product   Product  @relation(fields: [productId], references: [productId])
  user      User     @relation(fields: [userId], references: [telegramId])

  @@map("demo_access")
}

model Broadcast {
  broadcastId     String              @id @default(cuid()) @map("broadcast_id")
  title           String
  message         String
  targetType      BroadcastTargetType @map("target_type")
  status          BroadcastStatus     @default(DRAFT)
  scheduledAt     DateTime?           @map("scheduled_at")
  sentAt          DateTime?           @map("sent_at")
  createdBy       BigInt              @map("created_by")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  totalRecipients Int                 @default(0) @map("total_recipients")
  sentCount       Int                 @default(0) @map("sent_count")
  failedCount     Int                 @default(0) @map("failed_count")
  filters         BroadcastFilter[]
  messages        BroadcastMessage[]
  creator         User                @relation(fields: [createdBy], references: [telegramId])

  @@map("broadcasts")
}

model BroadcastMessage {
  messageId         String        @id @default(cuid()) @map("message_id")
  broadcastId       String        @map("broadcast_id")
  userId            BigInt        @map("user_id")
  status            MessageStatus @default(PENDING)
  sentAt            DateTime?     @map("sent_at")
  error             String?
  telegramMessageId Int?          @map("telegram_message_id")
  createdAt         DateTime      @default(now()) @map("created_at")
  broadcast         Broadcast     @relation(fields: [broadcastId], references: [broadcastId], onDelete: Cascade)
  user              User          @relation(fields: [userId], references: [telegramId])

  @@map("broadcast_messages")
}

model BroadcastFilter {
  filterId    String     @id @default(cuid()) @map("filter_id")
  broadcastId String     @map("broadcast_id")
  filterType  FilterType
  filterValue String
  createdAt   DateTime   @default(now()) @map("created_at")
  broadcast   Broadcast  @relation(fields: [broadcastId], references: [broadcastId], onDelete: Cascade)

  @@map("broadcast_filters")
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum PromoType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_TRIAL
}

enum BroadcastTargetType {
  ALL_USERS
  ACTIVE_SUBSCRIPTIONS
  EXPIRED_SUBSCRIPTIONS
  TRIAL_USERS
  PRODUCT_SPECIFIC
  CHANNEL_SPECIFIC
  CUSTOM_FILTER
}

enum BroadcastStatus {
  DRAFT
  SCHEDULED
  SENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum MessageStatus {
  PENDING
  SENT
  FAILED
}

enum FilterType {
  PRODUCT_ID
  CHANNEL_ID
  SUBSCRIPTION_STATUS
  USER_TAG
  REGISTRATION_DATE
}
