generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

model User {
  telegramId    BigInt         @id @map("telegram_id")
  username      String?        @unique
  firstName     String?        @map("first_name")
  createdAt     DateTime       @default(now()) @map("created_at")
  admin         Admin?
  payments      Payment[]
  subscriptions Subscription[]

  @@map("users")
}

model Admin {
  telegramId BigInt @id @map("telegram_id")
  user       User   @relation(fields: [telegramId], references: [telegramId])

  @@map("admins")
}

model Channel {
  channelId     BigInt         @id @map("channel_id")
  name          String
  username      String?        @unique
  description   String?
  createdAt     DateTime       @default(now()) @map("created_at")
  products      Product[]
  subscriptions Subscription[]

  @@map("channels")
}

model Product {
  productId     String         @id @default(cuid()) @map("product_id")
  channelId     BigInt         @map("channel_id")
  name          String
  description   String?
  price         Decimal        @db.Decimal(10, 2)
  periodDays    Int            @map("period_days")
  discountPrice Decimal?       @map("discount_price") @db.Decimal(10, 2)
  isTrial       Boolean        @default(false) @map("is_trial")
  isActive      Boolean        @default(true) @map("is_active")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  payments      Payment[]
  channel       Channel        @relation(fields: [channelId], references: [channelId])
  subscriptions Subscription[]

  @@map("products")
}

model Payment {
  paymentId     String         @id @default(cuid()) @map("payment_id")
  userId        BigInt         @map("user_id")
  productId     String         @map("product_id")
  amount        Decimal        @db.Decimal(10, 2)
  currency      String         @default("USDT")
  status        String         @default("pending")
  txHash        String?        @unique @map("tx_hash")
  memo          String?        @unique
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  product       Product        @relation(fields: [productId], references: [productId])
  user          User           @relation(fields: [userId], references: [telegramId])
  subscriptions Subscription[]

  @@map("payments")
}

model Subscription {
  subscriptionId String   @id @default(cuid()) @map("subscription_id")
  userId         BigInt   @map("user_id")
  productId      String   @map("product_id")
  channelId      BigInt   @map("channel_id")
  paymentId      String?  @map("payment_id")
  status         String   @default("active")
  startsAt       DateTime @default(now()) @map("starts_at")
  expiresAt      DateTime @map("expires_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  channel        Channel  @relation(fields: [channelId], references: [channelId])
  payment        Payment? @relation(fields: [paymentId], references: [paymentId])
  product        Product  @relation(fields: [productId], references: [productId])
  user           User     @relation(fields: [userId], references: [telegramId])

  @@index([status, expiresAt])
  @@map("subscriptions")
}
