name: Individual Cron Checks

on:
  workflow_dispatch:  # Запуск вручную с параметрами
    inputs:
      action:
        description: 'Which cron check to run'
        required: true
        default: 'subscriptions'
        type: choice
        options:
          - subscriptions
          - demo-access
          - scheduled-broadcasts
          - all

jobs:
  run-specific-check:
    runs-on: ubuntu-latest

    steps:
      - name: Run specific cron check
        run: |
          echo "Running cron check: ${{ github.event.inputs.action }}"

          APP_URL="${{ secrets.APP_URL }}"
          GITHUB_SECRET="${{ secrets.GH_CRON_SECRET }}"

          if [ -z "$APP_URL" ] || [ -z "$GITHUB_SECRET" ]; then
            echo "Error: Missing required secrets"
            exit 1
          fi

          # Выполняем конкретную проверку
          response=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $GITHUB_SECRET" \
            -d '{"action": "${{ github.event.inputs.action }}"}' \
            "$APP_URL/api/cron/github-check")

          echo "Response: $response"

          # Проверяем результат
          success=$(echo "$response" | jq -r '.success // false')

          if [ "$success" = "true" ]; then
            echo "✅ Cron check completed successfully"
          else
            echo "❌ Cron check failed"
            echo "$response" | jq '.'
            exit 1
          fi