# –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

## üõ†Ô∏è –ì–∞–π–¥ –ø–æ —Ä–µ—à–µ–Ω–∏—é —á–∞—Å—Ç—ã—Ö –ø—Ä–æ–±–ª–µ–º

–ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º –≤ —Å–∏—Å—Ç–µ–º–µ TMA-–ü–æ–¥–ø–∏—Å–∫–∞.

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### üìä Quick Diagnosis Checklist

#### üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è)
- [ ] **–°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω** - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Vercel status
- [ ] **–ü–ª–∞—Ç–µ–∂–∏ –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç** - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å NOWPayments API –∏ –∫–æ—à–µ–ª–µ–∫
- [ ] **–ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç** - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook –∏ —Ç–æ–∫–µ–Ω
- [ ] **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞** - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Vercel Storage

#### ‚ö†Ô∏è –°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (—Ä–µ–∞–∫—Ü–∏—è –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞)
- [ ] **Mini App –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è** - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- [ ] **–ü–æ–¥–ø–∏—Å–∫–∏ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç—Å—è** - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å cron jobs
- [ ] **–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç** - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
- [ ] **–ú–µ–¥–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞** - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

#### üìù –ù–∏–∑–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (—Ä–µ–∞–∫—Ü–∏—è –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è)
- [ ] **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è** - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É
- [ ] **Email –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è** - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SMTP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- [ ] **UI –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
- [ ] **–õ–æ–≥–∏ –æ—à–∏–±–æ–∫** - –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è

---

## üåê –ü—Ä–æ–±–ª–µ–º—ã —Å –≤–µ–±—Ö—É–∫–∞–º–∏ –∏ –±–æ—Ç–æ–º

### ü§ñ Telegram Bot –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç

#### üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞
curl "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getMe"

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤–µ–±—Ö—É–∫–∞
curl "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getWebhookInfo"

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
curl -X POST "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook" \
  -d "url=https://yourdomain.com/api/webhook/telegram"
```

#### ‚öôÔ∏è –†–µ—à–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞**
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω —É @BotFather
# –û–±–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è BOT_TOKEN –≤ Vercel
vercel env add BOT_TOKEN production
```

**–ü—Ä–æ–±–ª–µ–º–∞: –í–µ–±—Ö—É–∫ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω**
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤–µ–±—Ö—É–∫
curl -X POST "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook" \
  -d "url=https://yourdomain.com/api/webhook/telegram" \
  -d "secret_token=<YOUR_BOT_SECRET>"
```

**–ü—Ä–æ–±–ª–µ–º–∞: –í–µ–±—Ö—É–∫ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏**
```typescript
// app/api/webhook/telegram/route.ts - –¥–æ–±–∞–≤—å—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
export async function POST(request: Request) {
  try {
    const body = await request.json();
    console.log('Webhook received:', body);

    // –í–∞—à–∞ –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏

    return Response.json({ ok: true });
  } catch (error) {
    console.error('Webhook error:', error);
    return Response.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

### üì± Mini App –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è

#### üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Mini App URL
curl -I "https://yourdomain.com/app"

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ @BotFather
# BotFather ‚Üí Bot Settings ‚Üí Menu Button

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ initData
```

#### ‚öôÔ∏è –†–µ—à–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–≤–µ—Ä–Ω—ã–π URL Mini App**
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –≤ @BotFather
/start
/botsettings
/menubutton
/setwebapp
```

**–ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ Telegram WebApp**
```typescript
// lib/debug/telegram.ts - –≤—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
export function debugTelegramValidation(initData: string, botToken: string) {
  console.log('InitData:', initData);
  console.log('BotToken:', botToken.substring(0, 10) + '...');

  const isValid = validateTelegramWebApp(initData, botToken);
  console.log('Validation result:', isValid);

  if (!isValid) {
    console.error('WebApp validation failed!');
    return false;
  }

  return true;
}
```

---

## üí≥ –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏

### üîó NOWPayments –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

#### üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
```typescript
// lib/debug/ton.ts
export async function debugTonConnection() {
  const issues = [];

  // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞
  try {
    const response = await fetch('https://toncenter.com/api/v3/getAddressBalance', {
      method: 'POST',
      headers: {
        'X-API-KEY': process.env.NOWPAYMENTS_API_KEY!
      },
      body: JSON.stringify({ address: process.env.NOWPAYMENTS_API_KEY })
    });

    if (!response.ok) {
      issues.push('NOWPayments Center API key invalid or exhausted');
    }
  } catch (error) {
    issues.push('NOWPayments Center API unavailable');
  }

  // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –∫–æ—à–µ–ª—å–∫–∞
  try {
    const balance = await getWalletBalance();
    console.log('Wallet balance:', balance);
  } catch (error) {
    issues.push('Wallet balance check failed');
  }

  return issues;
}
```

#### ‚öôÔ∏è –†–µ—à–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞: API –∫–ª—é—á NOWPayments Center –∏—Å—Ç–µ–∫**
```bash
# 1. –ü–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—ã–π –∫–ª—é—á –Ω–∞ toncenter.com
# 2. –û–±–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
vercel env add NOWPAYMENTS_API_KEY production

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏
vercel functions list
vercel functions restart
```

**–ü—Ä–æ–±–ª–µ–º–∞: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç**
```typescript
// lib/debug/transaction.ts
export async function debugTransaction(paymentId: string) {
  const payment = await prisma.payment.findUnique({
    where: { payment_id: paymentId }
  });

  if (!payment) {
    return { error: 'Payment not found' };
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –±–ª–æ–∫—á–µ–π–Ω–µ
  const verifier = new PaymentVerifier();
  const isValid = await verifier.verifyTransaction(
    payment.tx_hash!,
    payment.amount,
    process.env.NOWPAYMENTS_API_KEY!
  );

  return {
    payment,
    transactionValid: isValid,
    issues: []
  };
}
```

### ‚è∞ –ü–ª–∞—Ç–µ–∂–∏ "–∑–∞—Å—Ç—Ä–µ–≤–∞—é—Ç" –≤ —Å—Ç–∞—Ç—É—Å–µ pending

#### üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ "–∑–∞–≤–∏—Å—à–∏—Ö" –ø–ª–∞—Ç–µ–∂–µ–π
SELECT
  payment_id,
  status,
  created_at,
  expires_at,
  NOW() as current_time,
  NOW() - expires_at as expired_duration
FROM payments
WHERE status = 'pending'
  AND expires_at < NOW()
ORDER BY created_at DESC;
```

#### ‚öôÔ∏è –†–µ—à–µ–Ω–∏—è

**–°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –æ—á–∏—Å—Ç–∫–∏:**
```typescript
// scripts/clean-expired-payments.ts
async function cleanExpiredPayments() {
  const expiredPayments = await prisma.payment.findMany({
    where: {
      status: 'pending',
      expires_at: {
        lt: new Date()
      }
    }
  });

  console.log(`Found ${expiredPayments.length} expired payments`);

  for (const payment of expiredPayments) {
    await prisma.payment.update({
      where: { id: payment.id },
      data: { status: 'expired' }
    });

    console.log(`Expired payment ${payment.payment_id}`);
  }
}
```

---

## üóÑÔ∏è –ü—Ä–æ–±–ª–µ–º—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

### üîå Connection Pool –∏—Å—á–µ—Ä–ø–∞–Ω

#### üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
SELECT
  state,
  COUNT(*) as connection_count
FROM pg_stat_activity
WHERE datname = current_database()
GROUP BY state;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–ª–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
SELECT
  query,
  calls,
  total_time,
  mean_time,
  rows
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;
```

#### ‚öôÔ∏è –†–µ—à–µ–Ω–∏—è

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è connection pool:**
```typescript
// lib/db/prisma.ts
export const prisma = new PrismaClient({
  datasources: {
    db: {
      url: process.env.POSTGRES_URL,
    },
  },
  log: process.env.NODE_ENV === 'development' ? ['query', 'error'] : ['error'],

  // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è serverless
  __internal: {
    engine: {
      connectionLimit: 10, // –£–º–µ–Ω—å—à–∏—Ç—å –ª–∏–º–∏—Ç
      poolTimeout: 10000,  // 10 —Å–µ–∫—É–Ω–¥
      idleTimeout: 30000,  // 30 —Å–µ–∫—É–Ω–¥
    },
  },
});
```

**–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
```sql
-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
CREATE INDEX CONCURRENTLY idx_payments_status_expires
ON payments(status, expires_at)
WHERE status = 'pending';

CREATE INDEX CONCURRENTLY idx_subscriptions_expires_active
ON subscriptions(expires_at)
WHERE status = 'active';
```

### üìä –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

#### üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
```sql
-- –í–∫–ª—é—á–µ–Ω–∏–µ pg_stat_statements –µ—Å–ª–∏ –µ—â–µ –Ω–µ –≤–∫–ª—é—á–µ–Ω
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- –ü–æ–∏—Å–∫ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
SELECT
  query,
  calls,
  total_exec_time,
  mean_exec_time,
  rows
FROM pg_stat_statements
WHERE mean_exec_time > 1000 -- –±–æ–ª—å—à–µ 1 —Å–µ–∫—É–Ω–¥—ã
ORDER BY mean_exec_time DESC
LIMIT 20;
```

#### ‚öôÔ∏è –†–µ—à–µ–Ω–∏—è

**–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:**
```typescript
// lib/cache/queries.ts
export async function getCachedProducts() {
  return getCachedData(
    'products:all',
    async () => {
      return prisma.product.findMany({
        where: { is_active: true },
        include: {
          channel: true
        },
        orderBy: { sort_order: 'asc' }
      });
    },
    300 // 5 –º–∏–Ω—É—Ç
  );
}

export async function getCachedUserSubscriptions(userId: number) {
  return getCachedData(
    `subscriptions:${userId}`,
    async () => {
      return prisma.subscription.findMany({
        where: {
          user_id: userId,
          status: 'active',
          expires_at: { gt: new Date() }
        },
        include: {
          product: {
            include: {
              channel: true
            }
          }
        }
      });
    },
    60 // 1 –º–∏–Ω—É—Ç–∞
  );
}
```

---

## ‚è∞ –ü—Ä–æ–±–ª–µ–º—ã —Å Cron Jobs

### üïê Cron –∑–∞–¥–∞—á–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è

#### üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ cron –≤ Vercel Dashboard
# Vercel ‚Üí Project ‚Üí Settings ‚Üí Functions ‚Üí Cron Jobs

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
vercel logs --filter="cron"

# 3. –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –¥–ª—è —Ç–µ—Å—Ç–∞
curl "https://yourdomain.com/api/cron/check-subscriptions"
```

#### ‚öôÔ∏è –†–µ—à–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–≤–µ—Ä–Ω—ã–π URL cron job**
```json
// vercel.json - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
{
  "crons": [
    {
      "path": "/api/cron/check-subscriptions",
      "schedule": "0 */6 * * *"
    }
  ]
}
```

**–ü—Ä–æ–±–ª–µ–º–∞: Timeout —Ñ—É–Ω–∫—Ü–∏–∏**
```typescript
// app/api/cron/check-subscriptions/route.ts
export async function GET() {
  const startTime = Date.now();

  try {
    // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ timeout –¥–ª—è cron
    const maxDuration = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç

    // –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
    const result = await checkSubscriptions();

    const duration = Date.now() - startTime;
    console.log(`Cron completed in ${duration}ms`);

    return Response.json(result);
  } catch (error) {
    console.error('Cron failed:', error);
    return Response.json(
      { error: error.message },
      { status: 500 }
    );
  }
}
```

**–ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤:**
```typescript
async function checkSubscriptionsBatch(batchSize = 100) {
  let offset = 0;
  let totalProcessed = 0;

  while (true) {
    const subscriptions = await prisma.subscription.findMany({
      where: {
        status: 'active',
        expires_at: { lt: new Date() }
      },
      take: batchSize,
      skip: offset,
      include: {
        user: true,
        channel: true
      }
    });

    if (subscriptions.length === 0) break;

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–∫–µ—Ç–∞
    await processSubscriptionBatch(subscriptions);

    totalProcessed += subscriptions.length;
    offset += batchSize;

    console.log(`Processed batch: ${totalProcessed} subscriptions`);
  }

  return { processed: totalProcessed };
}
```

---

## üì± –ü—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é

### üêå –ú–µ–¥–ª–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ Mini App

#### üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
```typescript
// lib/debug/performance.ts
export function measurePerformance(name: string) {
  return function (target: any, propertyName: string, descriptor: PropertyDescriptor) {
    const method = descriptor.value;

    descriptor.value = async function (...args: any[]) {
      const start = performance.now();
      const result = await method.apply(this, args);
      const end = performance.now();

      console.log(`${name} took ${end - start} milliseconds`);
      return result;
    };
  };
}
```

#### ‚öôÔ∏è –†–µ—à–µ–Ω–∏—è

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:**
```typescript
// app/app/page.tsx
export default async function TmaPage() {
  // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
  const [products, userSubscriptions] = await Promise.all([
    getCachedProducts(),
    getUserSubscriptions(telegramId)
  ]);

  return <TmaPageContent products={products} subscriptions={userSubscriptions} />;
}
```

**Lazy loading –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:**
```typescript
// components/ProductList.tsx
import dynamic from 'next/dynamic';

const ProductCard = dynamic(() => import('./ProductCard'), {
  loading: () => <div>Loading...</div>,
  ssr: false
});

export function ProductList({ products }) {
  return (
    <div>
      {products.map(product => (
        <ProductCard key={product.id} product={product} />
      ))}
    </div>
  );
}
```

### üìà –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ API

#### üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
```bash
# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ Vercel Analytics
vercel analytics

# –ü—Ä–æ–≤–µ—Ä–∫–∞ rate limiting
curl -H "X-Forwarded-For: 192.168.1.1" \
     https://yourdomain.com/api/products

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ API
time curl https://yourdomain.com/api/products
```

#### ‚öôÔ∏è –†–µ—à–µ–Ω–∏—è

**–£—Å–∏–ª–µ–Ω–∏–µ rate limiting:**
```typescript
// lib/security/rateLimit.ts
export const strictRateLimit = rateLimit({
  windowMs: 60 * 1000, // 1 –º–∏–Ω—É—Ç–∞
  max: 10, // 10 –∑–∞–ø—Ä–æ—Å–æ–≤
  skipSuccessfulRequests: false,
  skipFailedRequests: false,
  standardHeaders: true,
  legacyHeaders: false
});
```

**–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ API –æ—Ç–≤–µ—Ç–æ–≤:**
```typescript
// app/api/products/route.ts
export async function GET() {
  return getCachedData(
    'api:products',
    async () => {
      const products = await prisma.product.findMany({
        where: { is_active: true },
        include: { channel: true }
      });

      return Response.json({ success: true, data: products });
    },
    300 // 5 –º–∏–Ω—É—Ç –∫—ç—à–∞
  );
}
```

---

## üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

### üìä Health Check Endpoint

```typescript
// app/api/health/detailed/route.ts
export async function GET() {
  const checks = {
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    version: process.env.npm_package_version,

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    database: await checkDatabase(),

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis
    redis: await checkRedis(),

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ NOWPayments API
    tonApi: await checkTonApi(),

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram API
    telegramApi: await checkTelegramApi(),

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
    diskSpace: await checkDiskSpace(),

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–º—è—Ç–∏
    memory: checkMemory()
  };

  const isHealthy = Object.values(checks).every(
    check => typeof check === 'object' ? check.status === 'ok' : check
  );

  return Response.json({
    status: isHealthy ? 'healthy' : 'unhealthy',
    checks
  }, {
    status: isHealthy ? 200 : 503
  });
}

async function checkDatabase() {
  try {
    const start = Date.now();
    await prisma.$queryRaw`SELECT 1`;
    const latency = Date.now() - start;

    return {
      status: 'ok',
      latency: `${latency}ms`
    };
  } catch (error) {
    return {
      status: 'error',
      error: error.message
    };
  }
}
```

### üîç Debug Middleware

```typescript
// middleware.ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(request: NextRequest) {
  // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
  if (process.env.NODE_ENV === 'development') {
    console.log(`${request.method} ${request.url}`);
    console.log('Headers:', Object.fromEntries(request.headers));
  }

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è –¥–µ–±–∞–≥–∞
  const response = NextResponse.next();
  response.headers.set('X-Debug-Timestamp', new Date().toISOString());
  response.headers.set('X-Debug-Version', process.env.npm_package_version || 'unknown');

  return response;
}

export const config = {
  matcher: ['/api/:path*', '/app/:path*']
};
```

---

## üìû –ü–æ–∏—Å–∫ –ø–æ–º–æ—â–∏

### üÜò –ö–æ–≥–¥–∞ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∑–∞ –ø–æ–º–æ—â—å—é

#### üö® –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –ø–æ–º–æ—â—å
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤–ª–∏—è—é—â–∏–µ –Ω–∞ –ø–ª–∞—Ç–µ–∂–∏**
- **–£—Ç–µ—á–∫–∞ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**
- **DDoS –∞—Ç–∞–∫–∏**
- **–ü–æ–ª–Ω–∞—è –Ω–µ—Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞**

#### üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏
1. **Vercel Support** - –ü—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
2. **Telegram Bot API** - –ü—Ä–æ–±–ª–µ–º—ã —Å –±–æ—Ç–æ–º
3. **NOWPayments Center** - –ü—Ä–æ–±–ª–µ–º—ã —Å –±–ª–æ–∫—á–µ–π–Ω–æ–º
4. **–°–æ–æ–±—â–µ—Å—Ç–≤–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤** - –û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã

### üìã –°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏

```typescript
// lib/debug/support-info.ts
export async function generateSupportInfo() {
  return {
    timestamp: new Date().toISOString(),

    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ
    system: {
      version: process.env.npm_package_version,
      nodeVersion: process.version,
      platform: process.platform,
      environment: process.env.NODE_ENV
    },

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    stats: {
      totalUsers: await prisma.user.count(),
      activeSubscriptions: await prisma.subscription.count({
        where: { status: 'active' }
      }),
      totalRevenue: await prisma.payment.aggregate({
        where: { status: 'completed' },
        _sum: { amount: true }
      })
    },

    // –ó–¥–æ—Ä–æ–≤—å–µ —Å–∏—Å—Ç–µ–º—ã
    health: {
      database: await checkDatabase(),
      redis: await checkRedis(),
      apis: {
        ton: await checkTonApi(),
        telegram: await checkTelegramApi()
      }
    },

    // –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏
    recentErrors: await getRecentErrors()
  };
}
```

### üìù –®–∞–±–ª–æ–Ω –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏

```
–¢–µ–º–∞: [–ö–†–ò–¢–ò–ß–ù–û] –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏

–°–∏—Å—Ç–µ–º–∞: TMA-–ü–æ–¥–ø–∏—Å–∫–∞
–í–µ—Ä—Å–∏—è: 1.0.0
–û–∫—Ä—É–∂–µ–Ω–∏–µ: Production

–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:
[–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã]

–®–∞–≥–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:
1. [–®–∞–≥ 1]
2. [–®–∞–≥ 2]
3. [–®–∞–≥ 3]

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
[–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã–ª–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏]

–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
[–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ]

–õ–æ–≥–∏ –æ—à–∏–±–æ–∫:
[Relevant log entries]

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
[–õ—é–±–∞—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è]
```

---

## üìö –ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### üîÑ –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ

#### –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
- [ ] **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å health endpoint**
- [ ] **–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –æ—à–∏–±–æ–∫**
- [ ] **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ cron –∑–∞–¥–∞—á**
- [ ] **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**

#### –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
- [ ] **–ê—É–¥–∏—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏**
- [ ] **–ü—Ä–æ–≤–µ—Ä–∫–∞ –±—ç–∫–∞–ø–æ–≤**
- [ ] **–ê–Ω–∞–ª–∏–∑ –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
- [ ] **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**

#### –ï–∂–µ–º–µ—Å—è—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
- [ ] **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ –±—ç–∫–∞–ø–æ–≤**
- [ ] **–ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏**
- [ ] **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**
- [ ] **–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è**

### üéØ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫

```typescript
// lib/monitoring/metrics.ts
export const criticalMetrics = {
  // –ë–∏–∑–Ω–µ—Å –º–µ—Ç—Ä–∏–∫–∏
  business: {
    dailyRevenue: 'revenue:daily',
    conversionRate: 'conversion:daily',
    activeUsers: 'users:active',
    churnRate: 'churn:monthly'
  },

  // –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏
  technical: {
    apiResponseTime: 'api:response_time',
    errorRate: 'errors:rate',
    databaseConnections: 'db:connections',
    cronExecutionTime: 'cron:duration'
  },

  // –ú–µ—Ç—Ä–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  security: {
    failedLogins: 'auth:failed',
    suspiciousTransactions: 'payments:suspicious',
    rateLimitHits: 'ratelimit:hits'
  }
};
```

---

**üéØ –ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ –ª—É—á—à–µ –ª–µ—á–µ–Ω–∏—è! –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–º–æ–≥–∞—é—Ç –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ø—Ä–æ–±–ª–µ–º.**

[üìä API —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫](./api-reference.md) | [üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](./database.md)