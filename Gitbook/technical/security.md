# –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã

## üõ°Ô∏è –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Ññ1 –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

---

## üéØ –£–≥—Ä–æ–∑—ã –∏ –º–æ–¥–µ–ª–∏ –∞—Ç–∞–∫

### üí° –û—Å–Ω–æ–≤–Ω—ã–µ —É–≥—Ä–æ–∑—ã
- **–§–∏—à–∏–Ω–≥** ‚Äî –ø–æ–¥–¥–µ–ª–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–ª—è –∫—Ä–∞–∂–∏ –¥–∞–Ω–Ω—ã—Ö
- **Man-in-the-Middle** ‚Äî –ø–µ—Ä–µ—Ö–≤–∞—Ç —Ç—Ä–∞—Ñ–∏–∫–∞ –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–æ–º –∏ —Å–µ—Ä–≤–µ—Ä–æ–º
- **SQL Injection** ‚Äî –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω–æ–≥–æ SQL –∫–æ–¥–∞
- **XSS (Cross-Site Scripting)** ‚Äî –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω–æ–≥–æ –∫–æ–¥–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- **CSRF (Cross-Site Request Forgery)** ‚Äî –ø–æ–¥–¥–µ–ª–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **DDoS –∞—Ç–∞–∫–∏** ‚Äî –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∑–∞–ø—Ä–æ—Å–∞–º–∏
- **–ü–ª–∞—Ç–µ–∂–Ω—ã–π —Ñ—Ä–æ–¥** ‚Äî –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏

### üéØ –ê—Ç–∞–∫—É–µ–º—ã–µ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏
- **API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã** ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å –∞—Ç–∞–∫
- **Telegram Bot API** ‚Äî –≤–µ–∫—Ç–æ—Ä –∞—Ç–∞–∫ —á–µ—Ä–µ–∑ Telegram
- **TON Connect** ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–ª–æ–∫—á–µ–π–Ω–æ–º
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** ‚Äî —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å** ‚Äî –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø

---

## üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

### ü§ñ Telegram WebApp –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

#### ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è initData

```typescript
// lib/security/telegram/validation.ts
import crypto from 'crypto';

export function validateTelegramWebApp(initData: string, botToken: string): boolean {
  try {
    const urlParams = new URLSearchParams(initData);
    const hash = urlParams.get('hash');

    if (!hash) {
      return false;
    }

    // –°–æ–∑–¥–∞–µ–º data-check-string
    const sortedKeys = Array.from(urlParams.keys())
      .filter(key => key !== 'hash')
      .sort();

    const dataCheckString = sortedKeys
      .map(key => `${key}=${urlParams.get(key)}`)
      .join('\n');

    // –°–æ–∑–¥–∞–µ–º —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á
    const secretKey = crypto
      .createHmac('sha256', 'WebAppData')
      .update(botToken)
      .digest();

    // –í—ã—á–∏—Å–ª—è–µ–º —Ö–µ—à
    const expectedHash = crypto
      .createHmac('sha256', secretKey)
      .update(dataCheckString)
      .digest('hex');

    return hash === expectedHash;
  } catch (error) {
    console.error('Telegram validation error:', error);
    return false;
  }
}
```

#### üïê –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

```typescript
// lib/security/telegram/time.ts
export function validateTimestamp(initData: string): boolean {
  try {
    const urlParams = new URLSearchParams(initData);
    const authDate = parseInt(urlParams.get('auth_date') || '0');
    const currentTime = Math.floor(Date.now() / 1000);
    const maxAge = 300; // 5 –º–∏–Ω—É—Ç

    return (currentTime - authDate) <= maxAge;
  } catch (error) {
    return false;
  }
}
```

### üé´ JWT –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

```typescript
// lib/security/jwt.ts
import jwt from 'jsonwebtoken';

export const jwtConfig = {
  secret: process.env.JWT_SECRET!,
  algorithm: 'HS256',
  expiresIn: '24h',
  issuer: 'tma-subscription',
  audience: 'tma-users'
};

export function generateAdminToken(admin: Admin): string {
  return jwt.sign(
    {
      telegram_id: admin.telegram_id,
      role: admin.role,
      permissions: admin.permissions
    },
    jwtConfig.secret,
    {
      algorithm: jwtConfig.algorithm,
      expiresIn: jwtConfig.expiresIn,
      issuer: jwtConfig.issuer,
      audience: jwtConfig.audience
    }
  );
}

export function verifyAdminToken(token: string): any {
  try {
    return jwt.verify(token, jwtConfig.secret, {
      algorithms: [jwtConfig.algorithm],
      issuer: jwtConfig.issuer,
      audience: jwtConfig.audience
    });
  } catch (error) {
    throw new Error('Invalid or expired token');
  }
}
```

---

## üí≥ –ó–∞—â–∏—Ç–∞ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

### üîí TON Connect –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

#### ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

```typescript
// lib/security/ton/verification.ts
import { TonClient } from '@ton/ton';

export class PaymentVerifier {
  private client: TonClient;

  constructor() {
    this.client = new TonClient({
      endpoint: 'https://toncenter.com/api/v2/jsonRPC',
      apiKey: process.env.TONCENTER_API_KEY
    });
  }

  async verifyTransaction(txHash: string, expectedAmount: string, expectedRecipient: string): Promise<boolean> {
    try {
      // –ü–æ–ª—É—á–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏–∑ –±–ª–æ–∫—á–µ–π–Ω–∞
      const transaction = await this.client.getTransaction(txHash);

      if (!transaction) {
        throw new Error('Transaction not found');
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è
      const recipient = transaction.out_msgs[0]?.destination?.to_string();
      if (recipient !== expectedRecipient) {
        throw new Error('Invalid recipient');
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É–º–º—É (–¥–ª—è USDT - –≤ –Ω–∞–Ω–æ—Ç–æ–Ω–∞—Ö)
      const amount = transaction.out_msgs[0]?.value?.toString();
      if (amount !== expectedAmount) {
        throw new Error('Invalid amount');
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–∞
      if (transaction.in_msg?.status !== 1) {
        throw new Error('Transaction failed');
      }

      return true;
    } catch (error) {
      console.error('Transaction verification failed:', error);
      return false;
    }
  }

  // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
  async checkDuplicatePayment(txHash: string): Promise<boolean> {
    const existingPayment = await prisma.payment.findUnique({
      where: { tx_hash: txHash }
    });

    return existingPayment !== null;
  }
}
```

#### üõ°Ô∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö memo

```typescript
// lib/security/ton/memo.ts
import crypto from 'crypto';

export function generateSecureMemo(paymentId: string): string {
  const timestamp = Date.now();
  const nonce = crypto.randomBytes(8).toString('hex');

  // –§–æ—Ä–º–∞—Ç: TMA_PAY_{paymentId}_{timestamp}_{nonce}
  return `TMA_PAY_${paymentId}_${timestamp}_${nonce}`;
}

export function parseMemo(memo: string): { paymentId: string; timestamp: number } | null {
  try {
    const parts = memo.split('_');
    if (parts.length !== 4 || parts[0] !== 'TMA' || parts[1] !== 'PAY') {
      return null;
    }

    return {
      paymentId: parts[2],
      timestamp: parseInt(parts[3])
    };
  } catch (error) {
    return null;
  }
}
```

### ‚è∞ –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

```typescript
// lib/security/payments/timeout.ts
export class PaymentTimeout {
  private static readonly TRANSACTION_TIMEOUT = 30 * 60 * 1000; // 30 –º–∏–Ω—É—Ç

  static isExpired(createdAt: Date): boolean {
    const now = Date.now();
    const created = new Date(createdAt).getTime();

    return (now - created) > this.TRANSACTION_TIMEOUT;
  }

  static getExpiryDate(): Date {
    return new Date(Date.now() + this.TRANSACTION_TIMEOUT);
  }
}
```

---

## üõ°Ô∏è –ó–∞—â–∏—Ç–∞ API

### üö¶ Rate Limiting

```typescript
// lib/security/rateLimit.ts
import rateLimit from 'express-rate-limit';
import RedisStore from 'rate-limit-redis';
import { kv } from '@vercel/kv';

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Redis store
const redisStore = new RedisStore({
  client: kv,
  prefix: 'rl:'
});

// –û–±—â–∏–π rate limiting
export const generalRateLimit = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 –º–∏–Ω—É—Ç
  max: 1000, // 1000 –∑–∞–ø—Ä–æ—Å–æ–≤ —Å IP
  message: {
    error: 'Too many requests',
    retryAfter: '15 minutes'
  },
  standardHeaders: true,
  legacyHeaders: false,
  store: redisStore
});

// –°—Ç—Ä–æ–≥–∏–π rate limiting –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π
export const paymentRateLimit = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 –º–∏–Ω—É—Ç
  max: 5, // 5 –ø–æ–ø—ã—Ç–æ–∫ –ø–ª–∞—Ç–µ–∂–∞
  message: {
    error: 'Too many payment attempts',
    retryAfter: '15 minutes'
  },
  skipSuccessfulRequests: true,
  store: redisStore
});

// Rate limiting –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
export const adminRateLimit = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 –º–∏–Ω—É—Ç
  max: 100, // 100 –∑–∞–ø—Ä–æ—Å–æ–≤
  keyGenerator: (req) => {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º telegram_id –≤–º–µ—Å—Ç–æ IP
    return req.admin?.telegram_id || req.ip;
  },
  store: redisStore
});
```

### üîç –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

```typescript
// lib/security/validation.ts
import { z } from 'zod';

// –°—Ö–µ–º—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏
export const paymentInitSchema = z.object({
  product_id: z.number().positive().int(),
  promo_code: z.string().optional()
});

export const broadcastSchema = z.object({
  name: z.string().min(1).max(255),
  message: z.string().min(1).max(4096),
  send_type: z.enum(['immediate', 'scheduled']),
  scheduled_at: z.string().datetime().optional(),
  filters: z.array(z.object({
    type: z.string(),
    value: z.string()
  })).optional()
});

// –ú–∏–¥–ª–≤—ç—Ä—å –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
export function validateRequest(schema: z.ZodSchema) {
  return async (req: Request) => {
    try {
      const body = await req.json();
      const validated = schema.parse(body);
      return { success: true, data: validated };
    } catch (error) {
      return {
        success: false,
        error: 'Validation failed',
        details: error.errors
      };
    }
  };
}
```

### üö´ –ó–∞—â–∏—Ç–∞ –æ—Ç –∏–Ω—ä–µ–∫—Ü–∏–π

```typescript
// lib/security/sanitization.ts
export class Sanitizer {
  // –û—á–∏—Å—Ç–∫–∞ HTML –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è XSS
  static sanitizeHtml(input: string): string {
    return input
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#x27;')
      .replace(/\//g, '&#x2F;');
  }

  // –í–∞–ª–∏–¥–∞—Ü–∏—è SQL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  static validateSqlParam(param: any): boolean {
    if (typeof param === 'string') {
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ SQL –∏–Ω—ä–µ–∫—Ü–∏–∏
      const sqlInjectionPatterns = [
        /('|(\\')|(;)|(\-\-)|(\s+(or|and)\s+(\w+)?\s*=\s*(\w+)?)/i,
        /(union|select|insert|update|delete|drop|create|alter)/i,
        /(exec|execute|sp_|xp_)/i
      ];

      return !sqlInjectionPatterns.some(pattern => pattern.test(param));
    }

    return true;
  }

  // –û—á–∏—Å—Ç–∫–∞ –∏–º–µ–Ω —Ñ–∞–π–ª–æ–≤
  static sanitizeFileName(fileName: string): string {
    return fileName
      .replace(/[^a-zA-Z0-9\-_\.]/g, '_')
      .replace(/_{2,}/g, '_')
      .toLowerCase();
  }
}
```

---

## üîí –ó–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö

### üóùÔ∏è –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

```typescript
// lib/security/encryption.ts
import crypto from 'crypto';

export class Encryption {
  private static readonly algorithm = 'aes-256-gcm';
  private static readonly key = crypto.scryptSync(process.env.ENCRYPTION_KEY!, 'salt', 32);

  // –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  static encrypt(text: string): string {
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipher(this.algorithm, this.key);

    let encrypted = cipher.update(text, 'utf8', 'hex');
    encrypted += cipher.final('hex');

    const authTag = cipher.getAuthTag();

    return iv.toString('hex') + ':' + authTag.toString('hex') + ':' + encrypted;
  }

  // –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
  static decrypt(encryptedText: string): string {
    const parts = encryptedText.split(':');
    const iv = Buffer.from(parts[0], 'hex');
    const authTag = Buffer.from(parts[1], 'hex');
    const encrypted = parts[2];

    const decipher = crypto.createDecipher(this.algorithm, this.key);
    decipher.setAuthTag(authTag);

    let decrypted = decipher.update(encrypted, 'hex', 'utf8');
    decrypted += decipher.final('utf8');

    return decrypted;
  }

  // –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π –∏ —Ç–æ–∫–µ–Ω–æ–≤
  static hash(data: string): string {
    return crypto.pbkdf2Sync(data, 'salt', 10000, 64, 'sha512').toString('hex');
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
  static generateToken(length = 32): string {
    return crypto.randomBytes(length).toString('hex');
  }
}
```

### üõ°Ô∏è –ó–∞—â–∏—Ç–∞ PII (Personally Identifiable Information)

```typescript
// lib/security/pseudonymization.ts
export class Pseudonymizer {
  // –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram ID
  static maskTelegramId(telegramId: number): string {
    const idStr = telegramId.toString();
    const visible = idStr.slice(-4);
    const masked = '*'.repeat(idStr.length - 4);
    return masked + visible;
  }

  // –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ email
  static maskEmail(email: string): string {
    const [username, domain] = email.split('@');
    const visibleUsername = username.slice(0, 2);
    const maskedUsername = '*'.repeat(username.length - 2);
    return visibleUsername + maskedUsername + '@' + domain;
  }

  // –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
  static anonymizeUserData(userData: any): any {
    return {
      telegram_id_hash: this.hash(userData.telegram_id.toString()),
      language_code: userData.language_code,
      created_at: userData.created_at,
      // –ò—Å–∫–ª—é—á–∞–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    };
  }
}
```

---

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### üö® –î–µ—Ç–µ–∫—Ü–∏—è –∞–Ω–æ–º–∞–ª–∏–π

```typescript
// lib/security/anomalyDetection.ts
export class AnomalyDetector {
  // –î–µ—Ç–µ–∫—Ü–∏—è –∞–Ω–æ–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–ª–∞—Ç–µ–∂–µ–π
  static detectPaymentAnomaly(userId: number, paymentCount: number): boolean {
    const threshold = 10; // –ë–æ–ª—å—à–µ 10 –ø–ª–∞—Ç–µ–∂–µ–π –∑–∞ —á–∞—Å - –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ
    return paymentCount > threshold;
  }

  // –î–µ—Ç–µ–∫—Ü–∏—è –∞–Ω–æ–º–∞–ª—å–Ω—ã—Ö IP –∞–¥—Ä–µ—Å–æ–≤
  static detectSuspiciousActivity(ip: string, requestCount: number): boolean {
    const threshold = 1000; // –ë–æ–ª—å—à–µ 1000 –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ 15 –º–∏–Ω—É—Ç
    return requestCount > threshold;
  }

  // –î–µ—Ç–µ–∫—Ü–∏—è brute force –∞—Ç–∞–∫
  static detectBruteForce(userId: number, failedAttempts: number): boolean {
    const threshold = 5; // –ë–æ–ª—å—à–µ 5 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
    return failedAttempts > threshold;
  }

  // –°–æ–∑–¥–∞–Ω–∏–µ –∞–ª–µ—Ä—Ç–∞ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –∞–Ω–æ–º–∞–ª–∏–∏
  static async createAlert(type: string, details: any): Promise<void> {
    await prisma.securityAlert.create({
      data: {
        type,
        severity: 'high',
        details,
        status: 'open',
        created_at: new Date()
      }
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞–º
    await this.notifyAdmins(type, details);
  }
}
```

### üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

```typescript
// lib/security/logging.ts
export class SecurityLogger {
  private static logLevel = process.env.LOG_LEVEL || 'info';

  static async logSecurityEvent(event: {
    type: string;
    user_id?: number;
    ip_address?: string;
    user_agent?: string;
    details?: any;
    severity: 'low' | 'medium' | 'high' | 'critical';
  }): Promise<void> {
    // –ó–∞–ø–∏—Å—å –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    await prisma.securityLog.create({
      data: {
        type: event.type,
        user_id: event.user_id,
        ip_address: event.ip_address,
        user_agent: event.user_agent,
        details: event.details,
        severity: event.severity,
        timestamp: new Date()
      }
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Sentry –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π
    if (event.severity === 'critical') {
      Sentry.captureMessage(`Security Event: ${event.type}`, {
        level: 'error',
        extra: event
      });
    }

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    if (process.env.NODE_ENV === 'development') {
      console.log(`[SECURITY] ${event.type}:`, event);
    }
  }

  // –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞
  static async logLoginAttempt(user_id: number, success: boolean, ip: string): Promise<void> {
    await this.logSecurityEvent({
      type: success ? 'login_success' : 'login_failed',
      user_id,
      ip_address: ip,
      severity: success ? 'low' : 'medium'
    });
  }

  // –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
  static async logSuspiciousTransaction(payment_id: string, reason: string): Promise<void> {
    await this.logSecurityEvent({
      type: 'suspicious_transaction',
      details: { payment_id, reason },
      severity: 'high'
    });
  }
}
```

---

## üõ†Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

```typescript
// next.config.js
const securityHeaders = [
  {
    key: 'X-DNS-Prefetch-Control',
    value: 'on'
  },
  {
    key: 'Strict-Transport-Security',
    value: 'max-age=63072000; includeSubDomains; preload'
  },
  {
    key: 'X-XSS-Protection',
    value: '1; mode=block'
  },
  {
    key: 'X-Frame-Options',
    value: 'DENY'
  },
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff'
  },
  {
    key: 'Referrer-Policy',
    value: 'origin-when-cross-origin'
  },
  {
    key: 'Content-Security-Policy',
    value: [
      "default-src 'self'",
      "script-src 'self' 'unsafe-eval' 'unsafe-inline'",
      "style-src 'self' 'unsafe-inline'",
      "img-src 'self' data: https:",
      "connect-src 'self' https://api.telegram.org https://toncenter.com",
      "font-src 'self'",
      "object-src 'none'",
      "base-uri 'self'",
      "form-action 'self'",
      "frame-ancestors 'none'"
    ].join('; ')
  }
];

const nextConfig = {
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: securityHeaders
      }
    ];
  }
};
```

### üîê –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ —Å–µ–∫—Ä–µ—Ç—ã

```typescript
// lib/config/security.ts
export const securityConfig = {
  // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤
  validateSecrets: () => {
    const requiredSecrets = [
      'BOT_TOKEN',
      'BOT_SECRET',
      'JWT_SECRET',
      'ENCRYPTION_KEY',
      'TON_WALLET_ADDRESS'
    ];

    const missing = requiredSecrets.filter(secret => !process.env[secret]);

    if (missing.length > 0) {
      throw new Error(`Missing required secrets: ${missing.join(', ')}`);
    }
  },

  // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–∏–ª—ã –ø–∞—Ä–æ–ª–µ–π/—Å–µ–∫—Ä–µ—Ç–æ–≤
  validateSecretStrength: (secret: string, name: string): boolean => {
    if (name === 'JWT_SECRET' || name === 'ENCRYPTION_KEY') {
      return secret.length >= 32;
    }

    if (name === 'BOT_TOKEN') {
      return secret.match(/^\d+:[a-zA-Z0-9_-]+$/) !== null;
    }

    return secret.length > 0;
  }
};
```

---

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –ø–∞—Ç—á–∏

### üì¶ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

```json
// package.json
{
  "scripts": {
    "security:audit": "npm audit",
    "security:fix": "npm audit fix",
    "deps:update": "npm update",
    "deps:check": "npm outdated"
  },
  "dependencies": {
    "express": "^4.18.2",
    "jsonwebtoken": "^9.0.2",
    "bcryptjs": "^2.4.3"
  }
}
```

### üéØ –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

```bash
#!/bin/bash
# scripts/security-update.sh

echo "üîí Checking for security updates..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
npm audit --audit-level=moderate

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤
npm update

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Prisma
npx prisma generate

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
npm test

# –î–µ–ø–ª–æ–π –≤ –ø—Ä–æ–¥–∞–∫—à–Ω
vercel --prod

echo "‚úÖ Security update completed!"
```

---

## üìã –ß–µ–∫-–ª–∏—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### ‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

- [ ] **–í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è** –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã
- [ ] **Telegram WebApp –≤–∞–ª–∏–¥–∞—Ü–∏—è** —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] **JWT —Ç–æ–∫–µ–Ω—ã** –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- [ ] **SSL/TLS** –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] **Security headers** —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- [ ] **Rate limiting** –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –≤—Å–µ—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- [ ] **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö** —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- [ ] **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ** —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
- [ ] **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏** —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –∞–Ω–æ–º–∞–ª–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω

### üõ°Ô∏è –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–µ–∂–µ–º–µ—Å—è—á–Ω–æ)

- [ ] **–ê—É–¥–∏—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π** –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏
- [ ] **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤** –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- [ ] **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** rate limiting
- [ ] **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ** –ø–∞–∫–µ—Ç–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- [ ] **–†–µ–≤—å—é** –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
- [ ] **–ü—Ä–æ–≤–µ—Ä–∫–∞** –±—ç–∫–∞–ø–æ–≤ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- [ ] **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–±–æ—è

### üéØ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–µ–∂–µ–∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ)

- [ ] **–ü–µ–Ω—Ç–µ—Å—Ç–∏–Ω–≥** —Å–∏—Å—Ç–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- [ ] **–ê—É–¥–∏—Ç –∫–æ–¥–∞** –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏
- [ ] **–ü—Ä–æ–≤–µ—Ä–∫–∞** —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è GDPR/CCPA
- [ ] **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ** –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- [ ] **–û–±—É—á–µ–Ω–∏–µ** –∫–æ–º–∞–Ω–¥—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

---

## üö® –ü–ª–∞–Ω —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã

### üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ —ç—Å–∫–∞–ª–∞—Ü–∏—è

```typescript
// lib/security/incidentResponse.ts
export const incidentResponsePlan = {
  // –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å —É—Ä–æ–≤–Ω—è
  severity: {
    critical: {
      responseTime: '15 –º–∏–Ω—É—Ç',
      escalation: ['CTO', 'Security Lead', 'CEO'],
      communication: ['–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', '–ö–æ–º–∞–Ω–¥–∞']
    },
    high: {
      responseTime: '1 —á–∞—Å',
      escalation: ['Security Lead', 'CTO'],
      communication: ['–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏']
    },
    medium: {
      responseTime: '4 —á–∞—Å–∞',
      escalation: ['Security Lead'],
      communication: ['–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∫–æ–º–∞–Ω–¥–∞']
    },
    low: {
      responseTime: '24 —á–∞—Å–∞',
      escalation: ['Security Lead'],
      communication: ['–ù–µ—Ç']
    }
  },

  // –®–∞–±–ª–æ–Ω—ã –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
  templates: {
    incidentNotification: "üö® –ú—ã –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—É —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –∏ —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞–¥ –µ—ë —Ä–µ—à–µ–Ω–∏–µ–º.",
    resolutionNotification: "‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞. –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤ —à—Ç–∞—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ."
  }
};
```

---

**üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚Äî —ç—Ç–æ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å, –∞ –Ω–µ —Ä–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞. –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –∞—É–¥–∏—Ç—ã –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –∑–∞—â–∏—Ç—É –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.**

[üõ†Ô∏è –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º](./troubleshooting.md) | [üìä API —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫](./api-reference.md)