# Исправление проблемы с выдачей демо-доступа

## Описание проблемы
При нажатии кнопки "Выдать демо-доступ" в панели администратора после выбора пользователя, продукта и периода демо-доступ не выдавался.

## Причины проблемы
1. **Некорректная обработка BigInt на фронтенде**: Попытка передать `BigInt()` в JSON.stringify, что вызывает ошибку сериализации
2. **Отсутствие проверки формата userId**: API эндпоинт не обрабатывал некорректные форматы userId
3. **Непоследовательное использование BigInt**: Разные части кода использовали разные подходы к работе с BigInt

## Исправления

### 1. Файл: `components/admin/DemoManagement.tsx`
**Проблема**: Строка 344 пыталась сериализовать BigInt
```typescript
// БЫЛО (ОШИБКА):
userId: BigInt(newDemoAccess.userId),
```

**Исправлено**: Удалена конвертация в BigInt на фронтенде
```typescript
// СТАЛО:
userId: newDemoAccess.userId,
```

### 2. Файл: `app/api/admin/demo/grant/route.ts`
**Проблема**: Отсутствие валидации и корректной конвертации userId

**Исправления**:
- Добавлена безопасная конвертация userId в BigInt с обработкой ошибок
- Добавлено логирование типов данных для диагностики
- Используется един переменная `userIdBigInt` во всем коде

```typescript
// Добавлено:
let userIdBigInt: bigint
try {
  userIdBigInt = BigInt(userId)
} catch (error) {
  console.error('❌ Invalid userId format:', userId, error)
  return createJsonResponse(
    { error: 'Invalid userId format', details: `Cannot convert userId "${userId}" to BigInt` },
    400
  )
}
```

## Инструкция по тестированию

### Шаг 1: Запуск приложения
1. Убедитесь, что приложение запущено на `http://localhost:3002`
2. Откройте панель администратора

### Шаг 2: Проверка логов
Откройте консоль разработчика в браузере и наблюдайте за логами:
- При выборе пользователя должны появиться логи поиска
- При нажатии "Выдать демо-доступ" должны появиться логи с данными

### Шаг 3: Процесс тестирования
1. Нажмите кнопку "Выдать демо-доступ"
2. Введите имя пользователя в поле поиска
3. Выберите пользователя из выпадающего списка
4. Выберите продукт из выпадающего списка
5. Укажите период демо (количество дней)
6. Нажмите кнопку "Выдать демо-доступ"

### Ожидаемый результат
- Демо-должен успешно создаться в базе данных
- Пользователь должен получить доступ к продукту на указанный период
- Модальное окно должно закрыться
- Список демо-доступов должен обновиться

### Возможные ошибки и их решение
1. **"Invalid userId format"** - Проверьте, что пользователь корректно выбран из списка
2. **"Product not found"** - Убедитесь, что продукт существует и активен
3. **"Product does not support demo access"** - Проверьте, что у продукта включена поддержка демо

## Технические детали

### BigInt в JavaScript/TypeScript
- JavaScript не поддерживает JSON сериализацию BigInt
- Всегда преобразовывайте BigInt в строки перед отправкой на фронтенд
- На бэкенде принимайте строки и конвертируйте их в BigInt

### Рекомендации для будущей разработки
1. Создать утилитарную функцию для безопасной конвертации BigInt
2. Добавить TypeScript типы для userId как string
3. Использовать единый подход к обработке BigInt во всех API эндпоинтах

## Контакты
При возникновении проблем проверьте:
- Консоль разработчика в браузере
- Логи сервера в терминале
- Базу данных на наличие созданных записей